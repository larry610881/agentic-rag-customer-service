---
paths:
  - "apps/backend/tests/**/*.py"
  - "apps/frontend/src/**/*.test.tsx"
  - "apps/frontend/src/**/*.test.ts"
  - "apps/frontend/src/**/*.integration.test.tsx"
  - "apps/frontend/e2e/**/*.ts"
---

# 測試完整性紅線（修改測試檔案時自動套用）

## 核心原則

> 測試是行為契約。通過修改測試來「消除」失敗，等同於撕毀契約。

## 紅線規則（違反即修正）

### 1. 禁止修改與當前需求無關的測試

- ❌ 禁止為了讓 CI 通過而修改「不是你這次需求所涉及的」測試檔案
- ❌ 禁止弱化既有斷言（如刪除 assert、放寬條件、改 expected 值）來迴避失敗
- ❌ 禁止加入 `@pytest.mark.skip` / `it.skip` / `xfail` 來跳過失敗的既有測試
- ✅ 唯一允許修改既有測試的情況：**需求明確要求改變行為**（例如 API 回傳格式變更，對應的測試斷言必須同步更新）

### 2. 既有測試失敗 = 你的程式碼有回歸

當新功能導致既有測試失敗時：

1. **停下來** — 不要繼續實作，先分析失敗原因
2. **歸因** — 判斷是你的程式碼引入了回歸，還是測試本身有 bug
3. **修程式碼** — 如果是回歸，修正你的實作使既有測試恢復通過
4. **報告** — 如果確認是測試本身的 bug（非本次變更導致），向使用者報告並等待確認後才修改

### 3. 全量測試執行時機

| 時機 | 指令 | 必要性 |
|------|------|--------|
| 功能實作完成後 | `make test` | **必須** |
| 提交 commit 前 | `make test && make lint` | **必須** |
| 修復既有測試失敗後 | 全量重跑 | **必須** |

### 4. 測試修改的合法場景

| 場景 | 允許 | 範例 |
|------|------|------|
| 需求變更導致行為改變 | ✅ | API 回傳格式從 `{ data }` 改為 `{ items }` → 更新斷言 |
| 新增測試案例 | ✅ | 為新功能新增 happy path + error path |
| 既有測試有 bug（非本次引入） | ⚠️ 需使用者確認 | fixture 配置錯誤、mock 過期 |
| 想讓 CI 綠燈 | ❌ | 刪除 assert、放寬條件、skip 測試 |
| 重構測試（不改行為） | ⚠️ 需使用者確認 | 提取共用 fixture、重命名 |
